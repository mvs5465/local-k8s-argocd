apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: fileserver
  namespace: argocd
spec:
  project: default
  source:
    path: manifests
    repoURL: file:///tmp/fileserver-repo
    targetRevision: HEAD
  destination:
    server: https://kubernetes.default.svc
    namespace: default
  syncPolicy:
    syncOptions:
    - CreateNamespace=true
    automated:
      prune: true
      selfHeal: true

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fileserver-app
  namespace: default
data:
  app.py: |
    import os
    import json
    from pathlib import Path
    from flask import Flask, render_template_string, send_file, abort

    app = Flask(__name__)

    # Get directory from environment variable
    BASE_DIR = os.environ.get('FILE_DIR', '/files')

    HTML_TEMPLATE = '''
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>File Server</title>
      <style>
        body {
          font-family: monospace;
          background: #0a0e27;
          color: #e0e0e0;
          padding: 20px;
          margin: 0;
        }
        h1 {
          color: #00d084;
          margin: 0 0 20px 0;
        }
        .path {
          color: #888;
          margin-bottom: 20px;
        }
        ul {
          list-style: none;
          padding: 0;
          margin: 0;
        }
        li {
          padding: 8px 0;
          border-bottom: 1px solid rgba(0, 208, 132, 0.1);
        }
        a {
          color: #00d084;
          text-decoration: none;
        }
        a:hover {
          text-decoration: underline;
        }
        .dir {
          color: #00d084;
          font-weight: bold;
        }
        .file {
          color: #aaa;
        }
        .size {
          color: #666;
          margin-left: 10px;
          font-size: 0.9em;
        }
      </style>
    </head>
    <body>
      <h1>üìÅ File Server</h1>
      <div class="path">{{ base_dir }}</div>
      <ul>
      {% for item in items %}
        <li>
          {% if item.is_dir %}
            <span class="dir">üìÇ {{ item.name }}/</span>
          {% else %}
            <a href="/download/{{ item.name }}" class="file">üìÑ {{ item.name }}</a>
            <span class="size">{{ item.size_kb }} KB</span>
          {% endif %}
        </li>
      {% endfor %}
      </ul>
    </body>
    </html>
    '''

    @app.route('/')
    def index():
      try:
        items = []
        path = Path(BASE_DIR)

        if not path.exists():
          return f"<h1>Error</h1><p>Directory not found: {BASE_DIR}</p>", 404

        for entry in sorted(path.iterdir()):
          if entry.is_dir():
            items.append({
              'name': entry.name,
              'is_dir': True,
              'size_kb': 0
            })
          else:
            size_kb = entry.stat().st_size / 1024
            items.append({
              'name': entry.name,
              'is_dir': False,
              'size_kb': f'{size_kb:.1f}' if size_kb < 1024 else f'{size_kb/1024:.1f}M'
            })

        return render_template_string(HTML_TEMPLATE, items=items, base_dir=BASE_DIR)
      except Exception as e:
        return f"<h1>Error</h1><p>{str(e)}</p>", 500

    @app.route('/download/<filename>')
    def download(filename):
      try:
        file_path = Path(BASE_DIR) / filename

        # Security: prevent directory traversal
        if not str(file_path).startswith(str(Path(BASE_DIR))):
          abort(403)

        if not file_path.exists() or not file_path.is_file():
          abort(404)

        return send_file(file_path, as_attachment=True)
      except Exception as e:
        abort(500)

    if __name__ == '__main__':
      app.run(host='0.0.0.0', port=5000)

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fileserver
  namespace: default
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fileserver
  template:
    metadata:
      labels:
        app: fileserver
    spec:
      containers:
      - name: fileserver
        image: python:3.11-slim
        workingDir: /app
        command:
        - sh
        - -c
        - pip install flask -q && python app.py
        ports:
        - containerPort: 5000
        env:
        - name: FILE_DIR
          value: "/shared-files"
        volumeMounts:
        - name: app
          mountPath: /app
        - name: files
          mountPath: /shared-files
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 200m
            memory: 256Mi
      volumes:
      - name: app
        configMap:
          name: fileserver-app
      - name: files
        hostPath:
          path: /tmp/files
          type: DirectoryOrCreate

---
apiVersion: v1
kind: Service
metadata:
  name: fileserver
  namespace: default
spec:
  type: LoadBalancer
  ports:
  - port: 5555
    targetPort: 5000
  selector:
    app: fileserver
